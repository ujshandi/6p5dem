<?php

class MY_Controller extends CI_Controller{
	var $privilage_x;
	public function __construct(){
		parent::__construct();		//$this->output->enable_profiler(true);
		# cek login
		if (is_login() == FALSE){
			redirect(base_url().'index.php/auth/login');
		}		
		# set privilage
		$this->set_privilage();
		
		// jika tidak diperbolehkan mengakses controller
		if ($this->can_access() == FALSE){
			redirect(base_url().'index.php/auth/login');
		}
	}
	function open(){		//$data = $this->session->userdata('dataUser');			//@echo"mycontroler";		//@var_dump($data);exit;				//get menu sesuai otoritas user		//$data = $_SESSION['dataUser'];		$data = $this->session->userdata('dataUser');		$query = $this->Authentikasi->listMenuUser($data["USER_ID"]);									$arrGroupingMenu = $this->_listMenuUser($query);																					//print_r($arrGroupingMenu);exit;		$menuUser = $this->build_menu($arrGroupingMenu);		$data['menuUser'] = $menuUser;				
		$this->load->view('layout/header',$data);
		$this->load->view('layout/menu', $data);		//$this->load->view('layout/menu');
	}	function openfront(){		$this->load->view('layoutfront/header');		$this->load->view('layoutfront/menu');	}
	
	function close(){
		$this->load->view('layout/footer');
	}		function closefront(){		$this->load->view('layoutfront/footer');	}			//============ untuk kebutuhan hak akses	function set_privilage(){		$data = $this->session->userdata('dataUser');				$fields = $this->Authentikasi->getUserPrivelege($data["USER_NAME"]);	//auth yanto	    		$privilage=null;		foreach($fields->result() as $field){			$privilage[$field->MENU_URL][0] = SUBSTR($field->PRIVILEGE,0,1);			$privilage[$field->MENU_URL][1] = SUBSTR($field->PRIVILEGE,1,1);			$privilage[$field->MENU_URL][2] = SUBSTR($field->PRIVILEGE,2,1);			$privilage[$field->MENU_URL][3] = SUBSTR($field->PRIVILEGE,3,1);			$privilage[$field->MENU_URL][4] = SUBSTR($field->PRIVILEGE,4,1);		}				$this->privilage_x = $privilage;	}		function can_access(){		$priv = $this->privilage_x;		$form = $this->router->fetch_class();		if($form){			if(array_key_exists($form, $priv)){				if($priv[$form][0] == 1){					return TRUE;				}else{					return FALSE;				}			}		}				return TRUE;	}	function can_view(){		$priv = $this->privilage_x;		$form = $this->router->fetch_class();		if($form){			if(array_key_exists($form, $priv)){				if($priv[$form][1] == 1){					return TRUE;				}else{					return FALSE;				}			}		}				return TRUE;	}	function can_insert(){		$priv = $this->privilage_x;		$form = $this->router->fetch_class();		if($form){			if(array_key_exists($form, $priv)){				if($priv[$form][2] == 1){					return TRUE;				}else{					return FALSE;				}			}		}				return TRUE;	}	function can_update(){		$priv = $this->privilage_x;		$form = $this->router->fetch_class();		if($form){			if(array_key_exists($form, $priv)){				if($priv[$form][3] == 1){					return TRUE;				}else{					return FALSE;				}			}		}				return TRUE;	}	function can_delete(){		$priv = $this->privilage_x;		$form = $this->router->fetch_class();		if($form){			if(array_key_exists($form, $priv)){				if($priv[$form][4] == 1){					return TRUE;				}else{					return FALSE;				}			}		}				return TRUE;	}			////////fungsi fungsi untuk create menu////////	function _listMenuUser($query){		   // var_dump($query);exit;				$arrGroupingMenu = array();		$groupingMenu = "";								$x = 1;					$parent = 0;        $classcss="";						foreach($query->result() as $row){						if($groupingMenu != $row->MENU_GROUPING_ID){						//$classcss = $this->switchIconGroup($row->MENU_NAME);				 																											$arrGroupingMenu[$x]	= array("text"=>$row->MENU_NAME,												"class"=>$classcss,												"link"=>base_url().$this->config->item('index_page').'/'.$row->MENU_URL,												"show_condition"=>TRUE,												"parent"=>0);									$parent = $x;								}else{				$arrGroupingMenu[$x]	= array("text"=>$row->MENU_NAME,												"class"=>"",												"link"=>base_url().$this->config->item('index_page').'/'.$row->MENU_URL,												"show_condition"=>TRUE,												"parent"=>$parent);						}						$groupingMenu = $row->MENU_GROUPING_ID;			$x++;						}			//var_dump($arrGroupingMenu);exit;		return $arrGroupingMenu;	}				function build_menu ( $menu )	{		$out='';			for ( $i = 1; $i <= count ( $menu ); $i++ )		{			if ( is_array ( $menu [ $i ] ) ) {//must be by construction but let's keep the errors home				if ( $menu [ $i ] [ 'show_condition' ] && $menu [ $i ] [ 'parent' ] == 0 ) {//are we allowed to see this menu?					 					$out .= '<li><a href= "' . $menu [ $i ] [ 'link' ] . '">';					$out .= $menu [ $i ] [ 'text' ] ;					$out .= '</a>';					$out .= $this->get_childs ( $menu, $i );					$out .= '</li>';									}			}			else {				die ( sprintf ( 'menu nr %s must be an array', $i ) );			}		}		return $out;	}		function get_childs ( $menu, $el_id )	{				$has_subcats = FALSE;		$out = '';		$out .= '<ul>' ;				for ( $i = 1; $i <= count ( $menu ); $i++ )		{			if ( $menu [ $i ] [ 'show_condition' ] && $menu [ $i ] [ 'parent' ] == $el_id ) {//are we allowed to see this menu?				$has_subcats = TRUE;				$add_class = ( $this->get_childs ( $menu, $i ) != FALSE ) ? ' subsubl' : '';				$out .= '<li><a href="' . $menu [ $i ] [ 'link' ] . '">';				$out .= '&nbsp;&nbsp;&nbsp';				$out .= $menu [ $i ] [ 'text' ];				$out .= '</a>';				//$out .= $this->get_childs ( $menu, $i );				$out .= '</li>' . "\n";			}		}		$out .= ' </ul> ';		return ( $has_subcats ) ? $out : FALSE;	}
}